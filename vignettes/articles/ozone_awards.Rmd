---
title: "Most Ozone-Polluted City in Mexico - 2017"
author: "Diego Valle-Jones"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

We can use the package to find out which city is the most ozone-polluted in all of Mexico.

First, we load the packages

```{r packages,warning=FALSE,message=FALSE}
## Auto-install required R packages
packs <- c("dplyr", "ggplot2", "gghighlight", "lubridate", "anomalize", 
           "aire.zmvm", "tidyr", "zoo", "plotly")
success <- suppressWarnings(sapply(packs, require, character.only = TRUE))
if (length(names(success)[!success])) {
  install.packages(names(success)[!success])
  sapply(names(success)[!success], require, character.only = TRUE)
}
## Not yet on cran
library("rsinaica")
```
Then we download the data for the whole year of 2017


```{r download_o3, cache=TRUE}
# Download all O3 pollution data in 2017
o3_2017 <- bind_rows(
  mapply(sinaica_param_data,
         "O3",
         seq(as.Date("2017-01-01"), as.Date("2017-12-01"), by = "month"),
         seq(as.Date("2017-02-01"), as.Date("2018-01-01"), by = "month") - 1,
         remove_extremes = FALSE,
         SIMPLIFY = FALSE)
)
       
```
This is what the data looks like:

```{r}
knitr::kable(head(o3_2017))
```

Once we've downloaded the data we filter values below 1e-4 since they're calibration errors and also filter some stations that never report correct ozone values.

```{r plot}
# o3_2017[which(o3_2017$value_actual != o3_2017$value_original),]
# o3_2017[which(!is.na(o3_2017$date_validated)),]

# Only include stations that reported for more than 80% of days (292)
df_filtered <- o3_2017 %>%
  filter(!is.na(value)) %>%
  filter(value > .0001) %>%
  add_count(station_id, network_name) %>%
  ## these stations are mostly error values
  filter(!station_id %in% c(173, #"Facultad Psicología" SLP
                            72, #"Bomberos" Irapuato
                            31, #CBTIS ags 
                            303, #Instituto Educativo ags
                            39, #COCABH Mexicali
                            56 #Conalep torreon
                            )) %>%
  # filter values above .095 (bad (MALA) air quality)
  # that occurred during the night, since ozone is a photosensitive
  # pollutant
  filter(!(value > .0955 & hour %in% c(0:11, 20:23))) %>%
  filter(value < .3)

df_filtered %>%
  group_by(network_name) %>%
  summarise(count = n()) %>%
  arrange(count) %>%
  head(10) %>%
  knitr::kable()


df_max <- df_filtered %>%
  group_by(date, network_name) %>%
  summarise(max = max(value, na.rm = TRUE)) %>%
  ungroup() %>%
  add_count(network_name) %>%
  filter(n > (365*.8))  %>%
  select(-n) %>%
  arrange(network_name)
```

```{r, fig.widht = 8, fig.height = 18}
ggplot(df_max, aes(as.Date(date), max)) +
  geom_line(size = .3, color = "black") +
  facet_wrap(~ network_name, ncol = 3) +
  ggtitle("Maximum daily ozone concentration by network") +
  xlab("date") +
  ylab("daily maximum hourly ozone concentration (ppm)") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=60,hjust=1))

# ggplot(df_filtered %>%
#   mutate(date = as.POSIXct(paste0(date, " ", hour, ":00")),  tz = "Etc/GMT+6"), aes(date, value)) +
#   geom_line(size = .3, color = "black")+
#   facet_wrap(~ network_name, ncol = 3) +
#   ggtitle("Maximum daily ozone concentration by network") +
#   xlab("date") +
#   ylab("daily maximum hourly ozone concentration (ppm)") +
#   theme_bw() +
#   theme(axis.text.x=element_text(angle=60,hjust=1))

df_max <- df_max %>%
  ungroup() %>%
  group_by(network_name) %>%
  mutate(date = as.Date(date)) %>%
  time_decompose(max) %>%
  anomalize(remainder, method = "iqr", alpha = .03) %>%
  time_recompose()

# df_max <- df_filtered %>%
#   mutate(date = as.POSIXct(paste0(date, " ", hour, ":00")),  tz = "Etc/GMT+6") %>%
#   ungroup() %>%
#   group_by(station_id) %>%
#   arrange(date) %>%
#   time_decompose(value, method = "stl") %>%
#   anomalize(remainder, method = "gesd", alpha = 0.0001) %>%
#   time_recompose()


# Anomaly Visualization
df_max %>% plot_anomalies(time_recomposed = TRUE, ncol = 3, alpha_dots = 0.25) +
  labs(title = "Tidyverse Anomalies", subtitle = "STL + GESD Methods") 

df_max <- filter(df_max, anomaly != "Yes")
```
It was decided to remove Piedras Negras

```{r}
df_max <- filter(df_max, network_name != "Piedras Negras")
gghighlight_line(df_max, aes(as.Date(date), observed, 
                              group = network_name, color = network_name),
                 mean(observed, na.rm = TRUE), max_highlight = 1) +
  theme_bw() +
  ggtitle("Pollution measuring network with highest average maximum ozone pollution values in 2017") +
  xlab("date") +
  ylab("daily maximum hourly ozone concentration (ppm)")
```


```{r plotly, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 4,out.width = '100%'}

top3 <- filter(df_max, network_name %in% c("Valle de México",
                                           "Guadalajara",
                                           "Monterrey"))[, 1:3]

top3 <- spread(top3, network_name, observed)
top3$date <- as.Date(as.Date(top3$date))
top3$`Valle de México` <- na.spline(top3$`Valle de México`)
top3$Guadalajara <- na.spline(top3$Guadalajara)
top3$Monterrey <- na.spline(top3$Monterrey)
x <- list(
  title = "date"
)
y <- list(
  title = "daily maximum ozone concentration (ppm)"
)

plot_ly(as.data.frame(top3), x = ~date, y = ~`Valle de México`, name = "Valle de México" ,
        type = 'scatter', mode = 'lines', line = list(color = '#e41a1c'), width = .5) %>%
  add_trace(y = ~Guadalajara, name = 'Guadalajara', mode = 'lines', line = list(color = '#377eb8'), width = .5) %>%
  add_trace(y = ~Monterrey, name = 'Monterrey', mode = 'lines', line = list(color = '#4daf4a'), width = .5) %>%
  layout(title = "Top 3 most ozone-polluted cities in Mexico", xaxis = x, yaxis = y)
```


```{r}
df_max %>%
  group_by(network_name) %>%
  filter(observed > 95.5/1000 ) %>%
  summarise(count = n()) %>%
  arrange(-count) %>%
  head() %>%
  knitr::kable()

df_max %>%
  group_by(network_name) %>%
  filter(observed > 154.4/1000) %>%
  summarise(count = n()) %>%
  arrange(-count) %>%
  head() %>%
  knitr::kable()

```
